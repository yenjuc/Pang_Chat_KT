package com.example.pangchat.contact

import android.content.Intent
import android.graphics.Bitmap
import android.graphics.BitmapFactory
import android.util.Log
import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import android.widget.Button
import android.widget.ImageView
import android.widget.RadioButton
import android.widget.TextView
import androidx.fragment.app.FragmentActivity
import androidx.lifecycle.MutableLiveData
import androidx.lifecycle.lifecycleScope
import androidx.recyclerview.widget.RecyclerView
import com.example.pangchat.MainActivity
import com.example.pangchat.R
import com.example.pangchat.fragment.data.Result
import com.example.pangchat.utils.CookiedFuel
import com.example.pangchat.websocketClient.webSocketClient
import com.github.kittinunf.fuel.coroutines.awaitByteArray
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.launch
import kotlinx.coroutines.withContext
import java.util.*

class FriendRequestAdapter(private val mContext: FragmentActivity?, private val data: LinkedList<Contact?>?) : RecyclerView.Adapter<FriendRequestAdapter.FriendRequestViewHolder?>() {

    private val _acceptResult = MutableLiveData<AddFriendResult>()

    class FriendRequestViewHolder(itemView: View) : RecyclerView.ViewHolder(itemView) {
        var avatar: ImageView = itemView.findViewById<ImageView?>(R.id.avatar_icon)
        var nickname: TextView = itemView.findViewById<TextView?>(R.id.nickname_text)
        var acceptButton: Button = itemView.findViewById<RadioButton>(R.id.accept)
        var refuseButton: Button = itemView.findViewById<RadioButton>(R.id.refuse)

    }

    override fun onCreateViewHolder(parent: ViewGroup, viewType: Int): FriendRequestViewHolder {

        val view = LayoutInflater.from(parent.context).inflate(R.layout.item_recycle_new_friends, parent, false)
        return FriendRequestViewHolder(view)
    }

    override fun onBindViewHolder(holder: FriendRequestViewHolder, position: Int) {

        val contact = data?.get(position)
        if (contact != null) {

            // holder.avatar.setImageResource(contact.getAvatar())
            mContext?.lifecycleScope?.launch{
                if(!webSocketClient.urlToBitmap.keys.contains(contact.getAvatar())){
                    // 发起下载图片请求
                    val bit: Bitmap;
                    withContext(Dispatchers.IO) {
                        val result = CookiedFuel.get(contact.getAvatar()).awaitByteArray();
                        bit = BitmapFactory.decodeByteArray(result, 0, result.size)
                        webSocketClient.urlToBitmap[contact.getAvatar()] = bit
                    }
                }
                holder.avatar.setImageBitmap(webSocketClient.urlToBitmap[contact.getAvatar()]) // 必须放在IO外面
            }

            holder.nickname.text = contact.getNickname()
            holder.acceptButton.setOnClickListener(View.OnClickListener {
                // 接受好友申请 -- 发送请求给数据库，成功后重新推进联系人页面
                mContext?.lifecycleScope?.launch {
                    contact.getUserId().let { it1 -> accept(it1) }

                    val intent = Intent(mContext, MainActivity::class.java)
                    intent.putExtra("fragment", "contact")

                    try {
                        mContext.startActivity(intent)
                    } catch (ActivityNotFoundException: Exception) {
                        Log.d("ImplicitIntents", "Can't handle this!")
                    }

                }
            })
            holder.refuseButton.setOnClickListener(View.OnClickListener {
                // 拒绝好友申请 -- 发送请求给数据库，成功后重新推进联系人页面
                mContext?.lifecycleScope?.launch {
                    contact.getUserId().let { it1 -> refuse(it1) }

                    val intent = Intent(mContext, MainActivity::class.java)
                    intent.putExtra("fragment", "contact")

                    try {
                        mContext.startActivity(intent)
                    } catch (ActivityNotFoundException: Exception) {
                        Log.d("ImplicitIntents", "Can't handle this!")
                    }

                }
            })
        }

    }

    override fun getItemCount(): Int {
        // TODO
        if (data != null) {
            return data.size
        }
        return 0
    }

    suspend fun accept(friendId: String) {
        val contactDataSource = ContactDataSource()

        val result: Result<AddFriendResult>

        withContext(Dispatchers.IO) {
            result = contactDataSource.acceptNewFriend(friendId)
        }

        if (result is Result.Success) {
            _acceptResult.value = result.data
        } else {
            // TODO：抛出并解析异常
        }

    }

    suspend fun refuse(friendId: String) {
        val contactDataSource = ContactDataSource()

        val result: Result<AddFriendResult>

        withContext(Dispatchers.IO) {
            result = contactDataSource.refuseNewFriend(friendId)
        }

        if (result is Result.Success) {
            _acceptResult.value = result.data
        } else {
            // TODO：抛出并解析异常
        }

    }

}